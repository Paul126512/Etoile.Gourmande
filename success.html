<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confirmation</title>
  <style>
    @font-face {
      font-family: 'Neue Haas';
      src: url('https://fonts.cdnfonts.com/css/neue-haas-grotesk-display-pro') format('woff2');
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    
    body {
      font-family: 'Neue Haas', sans-serif;
      background: #fff;
      color: #000;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      line-height: 1.6;
    }
    
    .confirmation-card {
      width: 90%;
      max-width: 500px;
      padding: 2rem;
      text-align: center;
      animation: fadeIn 0.8s ease-out;
    }
    
    .confirmation-header {
      margin-bottom: 2rem;
    }
    
    h1 {
      font-weight: 500;
      font-size: 1.8rem;
      margin: 0 0 0.5rem;
      letter-spacing: -0.5px;
    }
    
    .order-number {
      font-size: 0.9rem;
      letter-spacing: 1px;
      color: #666;
      margin-bottom: 2rem;
    }
    
    .divider {
      height: 1px;
      background: #eee;
      margin: 2rem 0;
    }
    
    .order-items {
      margin: 2rem 0;
      text-align: left;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 0.8rem 0;
      border-bottom: 1px solid #f5f5f5;
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .total {
      font-weight: 500;
      font-size: 1.1rem;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #000;
    }
    
    .client-info {
      background: #f9f9f9;
      padding: 1.2rem;
      margin: 2rem 0;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .thank-you {
      margin: 2rem 0;
      font-size: 0.9rem;
      color: #666;
    }
    
    .btn {
      background: #000;
      color: #fff;
      border: none;
      padding: 1rem 2rem;
      margin-top: 1rem;
      cursor: pointer;
      font-family: 'Neue Haas', sans-serif;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      width: 100%;
      max-width: 200px;
    }
    
    .btn:hover {
      background: #333;
      animation: pulse 0.5s ease;
    }
    
    .empty-message {
      padding: 2rem 0;
      color: #666;
    }
    
    @media (max-width: 600px) {
      .confirmation-card {
        padding: 1.5rem;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .btn {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="confirmation-card" id="confirmation-card">
    <!-- Contenu généré par JavaScript -->
  </div>

  <script>
document.addEventListener('DOMContentLoaded', async () => {
  const card = document.getElementById('confirmation-card');
  const panierPizzas = JSON.parse(localStorage.getItem('panier')) || [];
  const panierBoissons = JSON.parse(localStorage.getItem('boissons')) || [];
  const prenom = localStorage.getItem('prenomCommande') || '';
  const email = localStorage.getItem('emailCommande') || '';

  // Vérifier si le panier est vide
  if (panierPizzas.length === 0 && panierBoissons.length === 0) {
    card.innerHTML = `
      <div class="confirmation-header">
        <h1>Commande Vide</h1>
      </div>
      <div class="empty-message">
        Votre panier est actuellement vide.
      </div>
      <div class="divider"></div>
      <button class="btn" onclick="window.location.href='index.html'">Retour à l'accueil</button>
    `;
    return;
  }

  // Calculer le total et préparer les items
  let total = 0;
  let itemsHtml = '';
  let commandeDetails = {
    pizzas: [],
    boissons: []
  };

  // Traitement des pizzas
  panierPizzas.forEach(pizza => {
    let prix = pizza.prix;
    let supplements = [];

    if (pizza.supplements?.length > 0 && !(pizza.supplements.length === 1 && pizza.supplements[0].id === 'aucun')) {
      supplements = pizza.supplements.map(sup => ({
        nom: sup.nom,
        prix: sup.prix
      }));
      prix += pizza.supplements.reduce((acc, sup) => acc + sup.prix, 0);
    }

    total += prix;
    itemsHtml += `
      <div class="order-item">
        <span>${pizza.nom} <small>${pizza.taille ? `(${pizza.taille})` : ''}</small></span>
        <span>${prix.toFixed(2)}€</span>
      </div>
    `;

    commandeDetails.pizzas.push({
      nom: pizza.nom,
      taille: pizza.taille,
      prix: pizza.prix,
      supplements: supplements,
      prix_total: prix
    });
  });

  // Traitement des boissons
  panierBoissons.forEach(boisson => {
    const prixTotal = boisson.prix * boisson.quantite;
    total += prixTotal;
    itemsHtml += `
      <div class="order-item">
        <span>${boisson.nom} <small>(×${boisson.quantite})</small></span>
        <span>${prixTotal.toFixed(2)}€</span>
      </div>
    `;

    commandeDetails.boissons.push({
      nom: boisson.nom,
      quantite: boisson.quantite,
      prix_unitaire: boisson.prix,
      prix_total: prixTotal
    });
  });

  // Générer le numéro de commande
  const now = new Date();
  let orderNum = `CMD-${String(now.getDate()).padStart(2,'0')}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;

  try {
    // Enregistrement dans Supabase
    const response = await fetch('https://dtkcxmmedsinbdacrbmt.supabase.co/rest/v1/orders', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhhd2xuZWN4amZkaGduYmx0b3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NjQ1NTcsImV4cCI6MjA2NTE0MDU1N30.j4_ZR22bV7acZabBIduYhoLZlITwRYu6ToBF8MYvj5o',
        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhhd2xuZWN4amZkaGduYmx0b3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NjQ1NTcsImV4cCI6MjA2NTE0MDU1N30.j4_ZR22bV7acZabBIduYhoLZlITwRYu6ToBF8MYvj5o',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({
        numero_cmd: orderNum,
        prenom: prenom,
        email: email,
        total_price: total,
        details: commandeDetails,
        statut: 'en_attente',
        date_commande: now.toISOString()
      })
    });

    if (!response.ok) {
      throw new Error("Erreur lors de l'enregistrement");
    }

    // Afficher la confirmation
    card.innerHTML = `
      <div class="confirmation-header">
        <h1>Commande confirmée</h1>
        <div class="order-number">Référence: ${orderNum}</div>
      </div>
      
      ${prenom || email ? `
        <div class="client-info">
          ${prenom ? `<div><strong>Prénom:</strong> ${prenom}</div>` : ''}
          ${email ? `<div><strong>Email:</strong> ${email}</div>` : ''}
        </div>
      ` : ''}
      
      <div class="divider"></div>
      
      <div class="order-items">
        ${itemsHtml}
        <div class="total">Total: ${total.toFixed(2)}€</div>
      </div>
      
      <div class="thank-you">
        Merci pour votre commande. Vous recevrez un email de confirmation sous peu.
      </div>
      
      <button class="btn" onclick="window.location.href='index.html'">Retour</button>
    `;

  } catch (error) {
    console.error("Erreur:", error);
    card.innerHTML = `
      <div class="confirmation-header">
        <h1>Confirmation partielle</h1>
        <div class="order-number">Référence: ${orderNum}</div>
      </div>
      
      <div class="client-info">
        <p>Votre commande a été enregistrée mais une erreur est survenue lors de la confirmation.</p>
        <p>Veuillez conserver cette référence.</p>
      </div>
      
      <div class="divider"></div>
      
      <div class="order-items">
        ${itemsHtml}
        <div class="total">Total: ${total.toFixed(2)}€</div>
      </div>
      
      <button class="btn" onclick="window.location.href='index.html'">Retour</button>
    `;
  } finally {
    // Vider le localStorage
    localStorage.removeItem('panier');
    localStorage.removeItem('boissons');
    localStorage.removeItem('prenomCommande');
    localStorage.removeItem('emailCommande');
  }
});
</script>
</body>
</html>
