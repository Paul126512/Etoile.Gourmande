<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confirmation</title>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: white;
      color: black;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      animation: fadeIn 0.6s ease-out;
    }
    .confirmation-card {
      width: 100%;
      max-width: 500px;
      border: 2px solid black;
      padding: 30px;
      text-align: center;
    }
    h1 {
      font-weight: 300;
      letter-spacing: 2px;
      margin-bottom: 20px;
    }
    .empty-message {
      padding: 40px 0;
      font-style: italic;
    }
    .order-number {
      font-family: monospace;
      font-size: 1.2rem;
      margin: 20px 0;
      padding: 10px;
      border: 1px dashed black;
    }
    .order-details {
      margin: 30px 0;
      text-align: left;
    }
    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .total {
      font-weight: bold;
      text-align: right;
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid black;
    }
    .btn {
      background: black;
      color: white;
      border: none;
      padding: 12px 25px;
      margin-top: 30px;
      cursor: pointer;
    }
    .thank-you {
      margin-top: 30px;
      font-style: italic;
    }
  </style>
</head>
<body>


  <div class="confirmation-card" id="confirmation-card">
    <!-- Contenu généré par JavaScript -->
  </div>


















  

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const card = document.getElementById('confirmation-card');
  const panierPizzas = JSON.parse(localStorage.getItem('panier')) || [];
  const panierBoissons = JSON.parse(localStorage.getItem('boissons')) || [];
  const prenom = localStorage.getItem('prenomCommande') || '';
  const email = localStorage.getItem('emailCommande') || '';

  if (panierPizzas.length === 0 && panierBoissons.length === 0) {
    card.innerHTML = `
      <h1>ERREUR</h1>
      <div class="empty-message">
        Aucune commande trouvée.<br>
        Votre panier était vide.
      </div>
      <button class="btn" onclick="window.location.href='index.html'">RETOUR À L'ACCUEIL</button>
    `;
    return;
  }

  let total = 0;
  let itemsHtml = '';
  const commandeDetails = { pizzas: [], boissons: [] };

  panierPizzas.forEach(pizza => {
    let prix = pizza.prix;
    let supplements = [];

    if (pizza.supplements?.length > 0 && !(pizza.supplements.length === 1 && pizza.supplements[0].id === 'aucun')) {
      supplements = pizza.supplements.map(sup => ({
        nom: sup.nom,
        prix: sup.prix
      }));
      prix += pizza.supplements.reduce((acc, sup) => acc + sup.prix, 0);
    }

    total += prix;

    // Affichage des suppléments dans la commande
    const supplementsHtml = supplements.length > 0
      ? `<ul>${supplements.map(s => `<li>+ ${s.nom} (${s.prix.toFixed(2)}€)</li>`).join('')}</ul>`
      : '';

    itemsHtml += `
      <div class="order-item">
        <span>${pizza.nom} (${pizza.taille || 'standard'})</span>
        <span>${prix.toFixed(2)}€</span>
        ${supplementsHtml}
      </div>
    `;

    commandeDetails.pizzas.push({
      nom: pizza.nom,
      taille: pizza.taille,
      prix: pizza.prix,
      supplements,
      prix_total: prix
    });
  });

  panierBoissons.forEach(boisson => {
    const prixTotal = boisson.prix * boisson.quantite;
    total += prixTotal;
    itemsHtml += `
      <div class="order-item">
        <span>${boisson.nom} × ${boisson.quantite}</span>
        <span>${prixTotal.toFixed(2)}€</span>
      </div>
    `;

    commandeDetails.boissons.push({
      nom: boisson.nom,
      quantite: boisson.quantite,
      prix_unitaire: boisson.prix,
      prix_total: prixTotal
    });
  });

  // Fonction pour générer un numéro de commande unique quotidien
  async function genererNumeroCommande() {
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    const dateDebut = `${year}-${month}-${day}T00:00:00Z`;
    const dateFin = `${year}-${month}-${day}T23:59:59Z`;

    const response = await fetch(`https://dtkcxmmedsinbdacrbmt.supabase.co/rest/v1/orders?select=numero_cmd&created_at=gte.${dateDebut}&created_at=lte.${dateFin}`, {
      method: 'GET',
      headers: {
        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhhd2xuZWN4amZkaGduYmx0b3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NjQ1NTcsImV4cCI6MjA2NTE0MDU1N30.j4_ZR22bV7acZabBIduYhoLZlITwRYu6ToBF8MYvj5o',
        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhhd2xuZWN4amZkaGduYmx0b3ZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NjQ1NTcsImV4cCI6MjA2NTE0MDU1N30.j4_ZR22bV7acZabBIduYhoLZlITwRYu6ToBF8MYvj5o',
        'Prefer': 'count=exact',
      }
    });

    if (!response.ok) {
      throw new Error(`Erreur HTTP ${response.status} lors du comptage des commandes`);
    }

    const commandes = await response.json();
    const compteur = String(commandes.length + 1).padStart(3, '0');
    return `CMD-${day}${month}${year}-${compteur}`;
  }

  // Appel pour générer le numéro de commande
  let orderNum = await genererNumeroCommande();

  try {
    const response = await fetch('https://dtkcxmmedsinbdacrbmt.supabase.co/rest/v1/orders', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': 'VOTRE_API_KEY',
        'Authorization': 'Bearer VOTRE_API_KEY',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({
        numero_cmd: orderNum,
        prenom,
        email,
        total_price: total,
        details: commandeDetails,
        statut: 'en_attente',
        date_commande: new Date().toISOString()
      })
    });

    if (!response.ok) throw new Error("Erreur lors de l'enregistrement dans Supabase");

    card.innerHTML = `
      <h1>CONFIRMATION</h1>
      ${prenom ? `<p>Client: <strong>${prenom}</strong></p>` : ''}
      ${email ? `<p>${email}</p>` : ''}
      <div class="order-number">Commande n° <strong>${orderNum}</strong></div>
      <div class="order-details">
        <h2>VOTRE COMMANDE</h2>
        ${itemsHtml}
        <div class="total">TOTAL: ${total.toFixed(2)}€</div>
      </div>
      <div class="thank-you">
        Merci pour votre commande. Conservez ce numéro pour le suivi : <strong>${orderNum}</strong>.
      </div>
      <button class="btn" onclick="window.location.href='index.html'">RETOUR À L'ACCUEIL</button>
    `;
  } catch (error) {
    console.error("Erreur Supabase:", error);
    card.innerHTML = `
      <h1>CONFIRMATION PARTIELLE</h1>
      <div class="error-message">
        Votre commande a été enregistrée partiellement.<br>
        Conservez ce numéro de commande : <strong>${orderNum}</strong>.
      </div>
      <div class="order-details">
        <h2>RÉCAPITULATIF</h2>
        ${itemsHtml}
        <div class="total">TOTAL: ${total.toFixed(2)}€</div>
      </div>
      <button class="btn" onclick="window.location.href='index.html'">RETOUR À L'ACCUEIL</button>
    `;
  } finally {
    localStorage.removeItem('panier');
    localStorage.removeItem('boissons');
    localStorage.removeItem('prenomCommande');
    localStorage.removeItem('emailCommande');
  }
});
</script>

