<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Formulaire & Résumé commande</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>/* Style général inversé mais centrage conservé */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Montserrat', sans-serif;
}

body {
  background-color: #fff; /* Fond blanc au lieu de noir */
  color: #000; /* Texte noir au lieu de blanc */
  line-height: 1.6;
  padding: 0;
  margin: 0;
}

.header {
  background-color: #fff; /* Fond blanc */
  color: #000; /* Texte noir */
  padding: 2rem;
  text-align: center;
  border-bottom: 1px solid #000; /* Bordure noire */
}

.header h1 {
  font-weight: 400;
  letter-spacing: 0.5rem;
  text-transform: uppercase;
  font-size: 1.8rem;
}

.container {
  display: flex;
  justify-content: center; /* Centrage maintenu */
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
  gap: 3rem;
}

/* Formulaire */
#form {
  flex: 1;
  max-width: 500px;
  background-color: #fff; /* Fond blanc */
  padding: 2rem;
  border: 1px solid #000; /* Bordure noire */
}

/* Résumé commande */
.summary {
  flex: 1;
  max-width: 500px;
  background-color: #fff; /* Fond blanc */
  padding: 2rem;
  border: 1px solid #000; /* Bordure noire */
}

/* Tous les autres éléments avec inversion de couleur */
input {
  border: 1px solid #000; /* Bordure noire */
  color: #000; /* Texte noir */
}

.article-panier {
  border-bottom: 1px solid #000; /* Bordure noire */
}

.details-panier img {
  border: 1px solid #000; /* Bordure noire */
}

.supprimer {
  color: #000; /* Texte noir */
}

#payer-btn, #btn-retour {
  color: #000; /* Texte noir */
  border: 1.5px solid #000; /* Bordure noire */
}

#payer-btn::before, #btn-retour::before {
  background: #000; /* Fond noir pour l'effet hover */
}

#payer-btn:hover, #btn-retour:hover {
  color: #fff !important; /* Texte blanc au survol */
}

</style>


  



</head>
<body>


<header class="header">
  <h1>COMMANDE</h1>

 

</header>

<a href="Card.html" id="btn-retour" class="btn-disabled" aria-disabled="true">
   <span class="btn-icon">←</span> Retour
</a>




<div class="container">
  <form id="form">
    <h2>Inscription</h2>

    <label for="name">Prénom</label>
    <input type="text" id="name" name="name" required />

    <label for="email">Email</label>
    <input type="email" id="email" name="email" required />

    <button type="submit">Envoyer</button>

    <p id="message"></p>
  </form>

  <div class="summary">
    <h3>Résumé de votre commande</h3>
    <div id="commande-list">
      <div id="liste-pizzas-panier"></div>
      <div id="liste-panier"></div>
    </div>
    <div id="commande-total" class="commande-total"></div>
  </div>
</div>

  

   <script src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const listePanier = document.getElementById('liste-panier');
        const commandeTotal = document.getElementById('commande-total');
        const payerBtn = document.getElementById('payer-btn');
        const prixStripeSpan = document.getElementById('prix-stripe');
        const form = document.getElementById('form');
        const message = document.getElementById('message');

        if (!listePanier) console.error("Error: Element with ID 'liste-panier' not found.");
        if (!commandeTotal) console.error("Error: Element with ID 'commande-total' not found.");
        if (!payerBtn) console.error("Error: Element with ID 'payer-btn' not found.");
        if (!prixStripeSpan) console.error("Error: Element with ID 'prix-stripe' not found.");
        if (!form) console.error("Error: Element with ID 'form' not found.");
        if (!message) console.error("Error: Element with ID 'message' not found.");

        // Les suppléments disponibles ne sont pas utilisés dans ce script pour le calcul du prix final
        // ou l'envoi à la commande, mais s'ils sont pertinents pour l'affichage, ils peuvent rester.
        // const supplementsDisponibles = [
        //     { id: 'sup1', nom: 'OLD SYSTEM / DISABLE', prix: 1.50 },
        //     { id: 'sup2', nom: 'OLD SYSTEM / DISABLE', prix: 2.00 },
        //     { id: 'sup3', nom: 'OLD SYSTEM / DISABLE', prix: 1.00 },
        //     { id: 'sup4', nom: 'OLD SYSTEM / DISABLE ! ', prix: 1.20 },
        // ];

        let panier = JSON.parse(localStorage.getItem('panier')) || [];

        panier = panier.map(item => ({
            ...item,
            quantite: item.quantite || 1,
            supplements: item.supplements || []
        }));

        function calculerPrixTotalItem(item) {
            const prixBase = item.prix || 0;
            return prixBase * (item.quantite || 1);
        }

        function groupItems(items) {
            const groups = [];
            items.forEach(item => {
                const supplementsIdsSorted = item.supplements.map(s => s.id).sort();

                const found = groups.find(g => {
                    const gSupplementsIdsSorted = g.supplements.map(s => s.id).sort();
                    return (
                        g.id === item.id &&
                        g.taille === item.taille &&
                        JSON.stringify(gSupplementsIdsSorted) === JSON.stringify(supplementsIdsSorted)
                    );
                });

                if (found) {
                    found.items.push(item);
                } else {
                    groups.push({
                        id: item.id,
                        taille: item.taille,
                        supplements: item.supplements,
                        items: [item]
                    });
                }
            });
            return groups;
        }

        function afficherPanier() {
            if (listePanier) {
                listePanier.innerHTML = '';
            } else {
                console.error("Cannot display cart: 'liste-panier' element not found.");
                return;
            }

            if (panier.length === 0) {
                listePanier.innerHTML = '<p>Votre panier est vide.</p>';
                if (commandeTotal) commandeTotal.textContent = '0.00 €';
                if (payerBtn) {
                    payerBtn.classList.add('btn-disabled');
                    payerBtn.setAttribute('aria-disabled', 'true');
                }
                if (prixStripeSpan) prixStripeSpan.textContent = '';
                return;
            }

            const groupedItems = groupItems(panier);
            let total = 0;

            groupedItems.forEach(group => {
                const item = group.items[0];
                const quantiteTotale = group.items.reduce((acc, it) => acc + (it.quantite || 1), 0);
                const prixTotalGroup = group.items.reduce((sum, it) => sum + calculerPrixTotalItem(it), 0);
                total += prixTotalGroup;

                const li = document.createElement('div');
                li.classList.add('article-panier');
                li.innerHTML = `
                    <div class="details-panier">
                        <img src="${item.image || 'https://via.placeholder.com/100?text=Produit'}" alt="${item.nom || 'Produit'}" />
                        <div>
                            <h4>${item.nom || 'Article inconnu'} ${quantiteTotale > 1 ? `x${quantiteTotale}` : ''}</h4>
                            <p><strong>Taille :</strong> ${item.taille || 'Standard'}</p>
                            <p>${item.description || ''}</p>
                            ${item.supplements && item.supplements.length > 0 ? `<p>Suppléments : ${item.supplements.map(s => s.nom).join(', ')}</p>` : ''}
                            <p class="prix-total">${prixTotalGroup.toFixed(2)} €</p>
                        </div>
                    </div>
                    <button class="supprimer" title="Supprimer cet article">×</button>
                `;

                li.querySelector('.supprimer').addEventListener('click', () => {
                    panier = panier.filter(pItem =>
                        !(pItem.id === item.id &&
                          pItem.taille === item.taille &&
                          JSON.stringify(pItem.supplements.map(s => s.id).sort()) === JSON.stringify(item.supplements.map(s => s.id).sort()))
                    );
                    sauvegarderPanier();
                    afficherPanier();
                });

                listePanier.appendChild(li);
            });

            if (commandeTotal) commandeTotal.textContent = total.toFixed(2) + ' €';

            if (payerBtn && prixStripeSpan) {
                if (total > 0) {
                    payerBtn.classList.remove('btn-disabled');
                    payerBtn.removeAttribute('aria-disabled');
                    prixStripeSpan.textContent = ` - ${total.toFixed(2)} €`;
                } else {
                    payerBtn.classList.add('btn-disabled');
                    payerBtn.setAttribute('aria-disabled', 'true');
                    prixStripeSpan.textContent = '';
                }
            }
        }

        function sauvegarderPanier() {
            localStorage.setItem('panier', JSON.stringify(panier));
        }

        function lancerAnimationErreur() {
            if (payerBtn) {
                payerBtn.classList.remove('btn-error');
                void payerBtn.offsetWidth;
                payerBtn.classList.add('btn-error');
            } else {
                console.warn("Attempted to launch error animation, but 'payer-btn' was not found.");
            }
        }

        if (form) {
            form.addEventListener('submit', async e => {
                e.preventDefault();

                const name = form.name.value.trim();
                const email = form.email.value.trim();

                if (name === '' || email === '') {
                    if (message) {
                        message.textContent = 'Veuillez remplir tous les champs.';
                        message.style.color = 'red';
                    }
                    lancerAnimationErreur();
                    return;
                }

                if (panier.length === 0) {
                    if (message) {
                        message.textContent = 'Votre panier est vide.';
                        message.style.color = 'red';
                    }
                    lancerAnimationErreur();
                    return;
                }

                if (message) {
                    message.textContent = 'Informations reçues, préparation du paiement...';
                    message.style.color = 'green';
                }

                // Filtrer le panier par type pour l'envoi au backend
                const panierPizzas = panier.filter(item => item.type === 'pizza');
                const panierBoissons = panier.filter(item => item.type === 'boisson');
                const panierBurgers = panier.filter(item => item.type === 'burger');
                const panierDesserts = panier.filter(item => item.type === 'dessert');
                const panierBaseCremes = panier.filter(item => item.type === 'basecreme');

                try {
                    const response = await fetch('/api/enregistrer-commande', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name,
                            email,
                            panierPizzas,
                            panierBoissons,
                            panierBurgers,
                            panierDesserts,
                            panierBaseCremes
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.message || "Erreur inconnue lors de l'enregistrement de la commande.");
                    }

                    const data = await response.json();

                    if (!window.Stripe) {
                        if (message) {
                            message.textContent = "Erreur: La bibliothèque Stripe.js n'est pas chargée.";
                            message.style.color = 'red';
                        }
                        lancerAnimationErreur();
                        return;
                    }

                    const stripe = Stripe('pk_test_51RTMhuLFHVbWJugP4qxMRQfifObErZnVAbMeDFwFTGcneOkBYomW3KFhvPHudKzoIn1IvdA6CAbOlL0lbAiNLrX300TLI92CDE');

                    const result = await stripe.redirectToCheckout({ sessionId: data.sessionId });

                    if (result.error) {
                        if (message) {
                            message.textContent = `Erreur Stripe: ${result.error.message}`;
                            message.style.color = 'red';
                        }
                        lancerAnimationErreur();
                    }
                } catch (error) {
                    if (message) {
                        message.textContent = `Erreur lors du traitement de la commande : ${error.message}`;
                        message.style.color = 'red';
                    }
                    lancerAnimationErreur();
                }
            });
        } else {
            console.error("Form element with ID 'form' not found. Form submission functionality will not work.");
        }

        afficherPanier();
    });
</script>



  
