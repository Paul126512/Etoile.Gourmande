<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Formulaire & R√©sum√© commande</title>


<style>
  /* Style g√©n√©ral noir et blanc */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Montserrat', sans-serif;
  }

  body {
    background-color: #000;
    color: #fff;
    line-height: 1.6;
    padding: 0;
    margin: 0;
  }

  .header {
    background-color: #000;
    color: #fff;
    padding: 2rem;
    text-align: center;
    border-bottom: 1px solid #fff;
  }

  .header h1 {
    font-weight: 400;
    letter-spacing: 0.5rem;
    text-transform: uppercase;
    font-size: 1.8rem;
  }

  .container {
    display: flex;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    gap: 3rem;
  }

  /* Formulaire */
  #form {
    flex: 1;
    max-width: 500px;
    background-color: #000;
    padding: 2rem;
    border: 1px solid #fff;
  }

  #form h2 {
    font-weight: 400;
    margin-bottom: 2rem;
    text-align: center;
    letter-spacing: 0.2rem;
    text-transform: uppercase;
    font-size: 1.5rem;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 300;
    letter-spacing: 0.1rem;
  }

  input {
    width: 100%;
    padding: 1rem;
    margin-bottom: 1.5rem;
    background-color: transparent;
    border: 1px solid #fff;
    color: #fff;
    font-size: 1rem;
  }

  input:focus {
    outline: none;
    border-color: #fff;
  }

button[type="submit"] {
  padding: 0.8rem 1.5rem;
  font-size: 1rem;
  border: 2px solid #ccc;
  background-color: #f5f5f5;
  color: #333;
  cursor: pointer;
  transition: all 0.3s ease;
}

/* üíö Style compl√®tement vert si valide */
button[type="submit"].valid {
  background-color: #28a745 !important; /* vert */
  border-color: #28a745 !important;
  color: #fff !important;
}


  #message {
    margin-top: 1rem;
    text-align: center;
    font-weight: 300;
  }

  /* R√©sum√© commande */
  .summary {
    flex: 1;
    max-width: 500px;
    background-color: #000;
    padding: 2rem;
    border: 1px solid #fff;
  }

  .summary h3 {
    font-weight: 400;
    margin-bottom: 2rem;
    text-align: center;
    letter-spacing: 0.2rem;
    text-transform: uppercase;
    font-size: 1.5rem;
  }

  #commande-list {
    margin-bottom: 2rem;
  }

  .article-panier {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid #fff;
    position: relative;
  }

  .details-panier {
    display: flex;
    gap: 1rem;
  }

  .details-panier img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border: 1px solid #fff;
  }

  .details-panier h4 {
    font-weight: 500;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05rem;
  }

  .details-panier p {
    font-weight: 300;
    font-size: 0.9rem;
    margin-bottom: 0.3rem;
  }

  .prix-total {
    font-weight: 500;
    margin-top: 0.5rem;
  }

  .supprimer {
    background: none;
    border: none;
    color: #fff;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0 0.5rem;
  }

  .commande-total {
    text-align: right;
    font-size: 1.2rem;
    font-weight: 500;
    letter-spacing: 0.1rem;
  }

 
#payer-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.8rem 1.5rem;
  margin: 2rem;
  text-decoration: none;
  color: #fff;
  border: 1.5px solid #fff;
  background: transparent;
  font-size: 0.8rem;
  letter-spacing: 0.1rem;
  font-weight: 500;
  text-transform: uppercase;
  gap: 0.5rem;
  position: relative;
  overflow: hidden;
  transition: color 0.2s 0.2s;
}

#payer-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 0;
  height: 100%;
  background: #fff;
  transition: width 0.3s ease-out;
  z-index: -1;
}

/* √âl√©ments du bouton (texte et ic√¥ne) */
#payer-btn > * {
  position: relative;
  z-index: 1;
}

#payer-btn:hover {
   color: #000 !important;
  transition-delay: 0.1s;
}

#payer-btn:hover::before {
  width: 100%;
}

/* Animation sp√©cifique pour le prix */
#prix-stripe {
  transition: transform 0.2s ease, color 0.2s;
}

#payer-btn:hover #prix-stripe {
  color: #000;
  transform: translateX(2px);
}

/* Style de l'ic√¥ne */
.btn-icon {
  transition: transform 0.2s ease;
}

#payer-btn:hover .btn-icon {
  transform: translateX(-3px);
}




#btn-retour {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.8rem 1.5rem;
  margin: 2rem;
  text-decoration: none;
  color: #fff;
  border: 1.5px solid #fff;
  background: transparent;
  font-size: 0.8rem;
  letter-spacing: 0.1rem;
  font-weight: 500;
  text-transform: uppercase;
  gap: 0.5rem;
  position: relative;
  overflow: hidden;
  transition: color 0.2s 0.2s;
}

#btn-retour::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 0;
  height: 100%;
  background: #fff;
  transition: width 0.3s ease-out;
  z-index: -1;
}


/* √âl√©ments du bouton (texte et ic√¥ne) */
#btn-retour > * {
  position: relative;
  z-index: 1;
}

#btn-retour:hover {
   color: #000 !important;
  transition-delay: 0.1s;
}

#btn-retour:hover::before {
  width: 100%;
}


#btn-retour:hover #prix-stripe {
  color: #000;
  transform: translateX(2px);
}

/* Style de l'ic√¥ne */
.btn-icon {
  transition: transform 0.2s ease;
}

#btn-retour:hover .btn-icon {
  transform: translateX(-3px);
}






/* √âtat d√©sactiv√© - √† garder en dernier pour priorit√© */
#payer-btn.btn-disabled {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: auto;
}

@keyframes clignoter {
  0%, 100% { background-color: red; }
  50% { background-color: #ff4d4d; }
}

.btn-error {
  background-color: red !important;
  animation: clignoter 0.4s ease-in-out 3;
}





</style>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">


</head>
<body>


<header class="header">
  <h1>COMMANDE</h1>

 

</header>

<a href="Card.html" id="btn-retour" class="btn-disabled" aria-disabled="true">
   <span class="btn-icon">‚Üê</span> Retour
</a>




<div class="container">
  <form id="form">
    <h2>Inscription</h2>

    <label for="name">Pr√©nom</label>
    <input type="text" id="name" name="name" required />

    <label for="email">Email</label>
    <input type="email" id="email" name="email" required />

    <button type="submit">Envoyer</button>

    <p id="message"></p>
  </form>

  <div class="summary">
    <h3>R√©sum√© de votre commande</h3>
    <div id="commande-list">
      <div id="liste-pizzas-panier"></div>
      <div id="liste-panier"></div>
    </div>
    <div id="commande-total" class="commande-total"></div>
  </div>
</div>


<script src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {

        // Element selections: These variables must find existing HTML elements.
        const listePanier = document.getElementById('liste-panier');
        const commandeTotal = document.getElementById('commande-total');
        const payerBtn = document.getElementById('payer-btn');
        const prixStripeSpan = document.getElementById('prix-stripe');
        const form = document.getElementById('form');
        const message = document.getElementById('message');

        // --- Robustness Checks: Log errors if elements are missing ---
        // These checks help identify if your HTML elements are correctly linked to the JavaScript.
        if (!listePanier) console.error("Error: Element with ID 'liste-panier' not found.");
        if (!commandeTotal) console.error("Error: Element with ID 'commande-total' not found.");
        if (!payerBtn) console.error("Error: Element with ID 'payer-btn' not found.");
        if (!prixStripeSpan) console.error("Error: Element with ID 'prix-stripe' not found.");
        if (!form) console.error("Error: Element with ID 'form' not found.");
        if (!message) console.error("Error: Element with ID 'message' not found.");

        // Define available supplements (if still used - marked as OLD SYSTEM / DISABLE in original)
        const supplementsDisponibles = [
            { id: 'sup1', nom: 'OLD SYSTEM / DISABLE', prix: 1.50 },
            { id: 'sup2', nom: 'OLD SYSTEM / DISABLE', prix: 2.00 },
            { id: 'sup3', nom: 'OLD SYSTEM / DISABLE', prix: 1.00 },
            { id: 'sup4', nom: 'OLD SYSTEM / DISABLE ! ', prix: 1.20 },
        ];

        // Retrieve cart from localStorage or initialize as an empty array.
        // The `panier` will hold all your cart items (pizzas, burgers, drinks, etc.).
        let panier = JSON.parse(localStorage.getItem('panier')) || [];

        // Ensure each item in the cart has a quantity and supplements array, defaulting if missing.
        panier = panier.map(item => ({
            ...item,
            quantite: item.quantite || 1,
            supplements: item.supplements || []
        }));

        /**
         * Calculates the total price of a single cart item, considering its quantity.
         * @param {object} item - The cart item object.
         * @returns {number} The total price for the item.
         */
        function calculerPrixTotalItem(item) {
            const prixBase = item.prix || 0;
            // This assumes supplement prices are already included in item.prix or are handled elsewhere.
            return prixBase * (item.quantite || 1);
        }

        /**
         * Groups identical items in the cart to display them as a single line item with a total quantity.
         * Items are considered identical if they have the same ID, size, and sorted supplements.
         * @param {Array<object>} items - The array of cart items.
         * @returns {Array<object>} An array of grouped items.
         */
        function groupItems(items) {
            const groups = [];
            items.forEach(item => {
                // Create a consistent key for grouping by sorting supplement IDs.
                const supplementsIdsSorted = item.supplements.map(s => s.id).sort();

                // Try to find an existing group for this item.
                const found = groups.find(g => {
                    const gSupplementsIdsSorted = g.supplements.map(s => s.id).sort();
                    return (
                        g.id === item.id &&
                        g.taille === item.taille &&
                        JSON.stringify(gSupplementsIdsSorted) === JSON.stringify(supplementsIdsSorted)
                    );
                });

                // If a group exists, add the item to it; otherwise, create a new group.
                if (found) {
                    found.items.push(item);
                } else {
                    groups.push({
                        id: item.id,
                        taille: item.taille,
                        supplements: item.supplements,
                        items: [item]
                    });
                }
            });
            return groups;
        }

        /**
         * Displays the current content of the cart in the DOM.
         * Updates the total price and the state of the payment button.
         */
        function afficherPanier() {
            // Clear existing cart display.
            if (listePanier) {
                listePanier.innerHTML = '';
            } else {
                console.error("Cannot display cart: 'liste-panier' element not found.");
                return;
            }

            // If the cart is empty, display a message and disable the payment button.
            if (panier.length === 0) {
                listePanier.innerHTML = '<p>Votre panier est vide.</p>';
                if (commandeTotal) commandeTotal.textContent = '0.00 ‚Ç¨';
                if (payerBtn) {
                    payerBtn.classList.add('btn-disabled');
                    payerBtn.setAttribute('aria-disabled', 'true');
                }
                if (prixStripeSpan) prixStripeSpan.textContent = '';
                return;
            }

            const groupedItems = groupItems(panier);
            let total = 0;

            // Iterate through grouped items to display them.
            groupedItems.forEach(group => {
                const item = group.items[0]; // Take the first item from the group for details.
                const quantiteTotale = group.items.reduce((acc, it) => acc + (it.quantite || 1), 0);
                const prixTotalGroup = group.items.reduce((sum, it) => sum + calculerPrixTotalItem(it), 0);
                total += prixTotalGroup;

                // Create a list item for each grouped product.
                const li = document.createElement('div');
                li.classList.add('article-panier');
                li.innerHTML = `
                    <div class="details-panier">
                        <img src="${item.image || 'https://via.placeholder.com/100?text=Produit'}" alt="${item.nom || 'Produit'}" />
                        <div>
                            <h4>${item.nom || 'Article inconnu'} ${quantiteTotale > 1 ? `x${quantiteTotale}` : ''}</h4>
                            <p><strong>Taille :</strong> ${item.taille || 'Standard'}</p>
                            <p>${item.description || ''}</p>
                            ${item.supplements && item.supplements.length > 0 ? `<p>Suppl√©ments : ${item.supplements.map(s => s.nom).join(', ')}</p>` : ''}
                            <p class="prix-total">${prixTotalGroup.toFixed(2)} ‚Ç¨</p>
                        </div>
                    </div>
                    <button class="supprimer" title="Supprimer cet article">√ó</button>
                `;

                // Add event listener to the remove button.
                li.querySelector('.supprimer').addEventListener('click', () => {
                    // Remove all items in the group from the cart.
                    panier = panier.filter(pItem =>
                        !(pItem.id === item.id &&
                          pItem.taille === item.taille &&
                          JSON.stringify(pItem.supplements.map(s => s.id).sort()) === JSON.stringify(item.supplements.map(s => s.id).sort()))
                    );
                    sauvegarderPanier(); // Save updated cart to localStorage.
                    afficherPanier();   // Re-render the cart display.
                });

                listePanier.appendChild(li);
            });

            // Update the overall total displayed.
            if (commandeTotal) commandeTotal.textContent = total.toFixed(2) + ' ‚Ç¨';

            // Update the payment button's state and text with the total price.
            if (payerBtn && prixStripeSpan) {
                if (total > 0) {
                    payerBtn.classList.remove('btn-disabled');
                    payerBtn.removeAttribute('aria-disabled');
                    prixStripeSpan.textContent = ` - ${total.toFixed(2)} ‚Ç¨`;
                } else {
                    payerBtn.classList.add('btn-disabled');
                    payerBtn.setAttribute('aria-disabled', 'true');
                    prixStripeSpan.textContent = '';
                }
            }
        }

        /**
         * Saves the current `panier` array to localStorage.
         */
        function sauvegarderPanier() {
            localStorage.setItem('panier', JSON.stringify(panier));
        }

        /**
         * Triggers a visual error animation on the payment button.
         */
        function lancerAnimationErreur() {
            if (payerBtn) {
                payerBtn.classList.remove('btn-error');
                // Force a reflow to restart the animation if it's already active.
                void payerBtn.offsetWidth;
                payerBtn.classList.add('btn-error');
            } else {
                console.warn("Attempted to launch error animation, but 'payer-btn' was not found.");
            }
        }

        // Handle form submission for payment.
        if (form) {
            form.addEventListener('submit', async e => {
                e.preventDefault(); // Prevent default form submission.

                const name = form.name.value.trim();
                const email = form.email.value.trim();

                // Basic validation for name and email.
                if (name === '' || email === '') {
                    if (message) {
                        message.textContent = 'Veuillez remplir tous les champs.';
                        message.style.color = 'red';
                    }
                    lancerAnimationErreur();
                    return;
                }

                // Check if the cart is empty before proceeding.
                if (panier.length === 0) {
                    if (message) {
                        message.textContent = 'Votre panier est vide.';
                        message.style.color = 'red';
                    }
                    lancerAnimationErreur();
                    return;
                }

                // Display a success/info message before API call.
                if (message) {
                    message.textContent = 'Informations re√ßues, pr√©paration du paiement...';
                    message.style.color = 'green';
                }

                try {
                    // Send the entire cart (panierItems) to your backend.
                    // Your backend will be responsible for differentiating between item types (pizza, burger, boisson, etc.)
                    const response = await fetch('/api/enregistrer-commande', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name,
                            email,
                            panierItems: panier // Send the full cart array
                        })
                    });

                    // Handle API response errors.
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.message || 'Erreur inconnue lors de l\'enregistrement de la commande.');
                    }

                    const data = await response.json();

                    // Check if Stripe.js library is loaded.
                    if (!window.Stripe) {
                        if (message) {
                            message.textContent = 'Erreur: La biblioth√®que Stripe.js n\'est pas charg√©e.';
                            message.style.color = 'red';
                        }
                        lancerAnimationErreur();
                        return;
                    }

                    // Initialize Stripe with your public test key.
                    const stripe = Stripe('pk_test_51RTMhuLFHVbWJugP4qxMRQfifObErZnVAbMeDFwFTGcneOkBYomW3KFhvPHudKzoIn1IvdA6CAbOlL0lbAiNLrX300TLI92CDE');

                    // Redirect the user to Stripe Checkout.
                    const result = await stripe.redirectToCheckout({ sessionId: data.sessionId });

                    // Handle any errors from Stripe redirection.
                    if (result.error) {
                        if (message) {
                            message.textContent = `Erreur Stripe: ${result.error.message}`;
                            message.style.color = 'red';
                        }
                        lancerAnimationErreur();
                    }
                } catch (error) {
                    // Catch and display any errors during the fetch or Stripe process.
                    if (message) {
                        message.textContent = `Erreur lors du traitement de la commande : ${error.message}`;
                        message.style.color = 'red';
                    }
                    lancerAnimationErreur();
                }
            });
        } else {
            console.error("Form element with ID 'form' not found. Form submission functionality will not work.");
        }

        // Initial display of the cart when the page loads.
        afficherPanier();
    }); // End DOMContentLoaded listener
</script>



