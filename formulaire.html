<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Formulaire & Résumé commande</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>/* Style général inversé mais centrage conservé */

/* Style général inversé */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Montserrat', sans-serif;
}

body {
  background-color: #fff;
  color: #000;
  line-height: 1.6;
  padding: 0;
  margin: 0;
}

.header {
  background-color: #fff;
  color: #000;
  padding: 2rem;
  text-align: center;
  border-bottom: 1px solid #000;
}

.header h1 {
  font-weight: 400;
  letter-spacing: 0.5rem;
  text-transform: uppercase;
  font-size: 1.8rem;
}

.container {
  display: flex;
  justify-content: space-between;
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
  gap: 3rem;
}

/* Formulaire */
#form {
  flex: 1;
  max-width: 500px;
  background-color: #fff;
  padding: 2rem;
  border: 1px solid #000;
}

#form h2 {
  font-weight: 400;
  margin-bottom: 2rem;
  text-align: center;
  letter-spacing: 0.2rem;
  text-transform: uppercase;
  font-size: 1.5rem;
  color: #000;
}

label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 300;
  letter-spacing: 0.1rem;
  color: #000;
}

input {
  width: 100%;
  padding: 1rem;
  margin-bottom: 1.5rem;
  background-color: transparent;
  border: 1px solid #000;
  color: #000;
  font-size: 1rem;
}

input:focus {
  outline: none;
  border-color: #000;
}

button[type="submit"] {
  padding: 0.8rem 1.5rem;
  font-size: 1rem;
  border: 2px solid #333;
  background-color: #f5f5f5;
  color: #000;
  cursor: pointer;
  transition: all 0.3s ease;
}

button[type="submit"].valid {
  background-color: #28a745 !important;
  border-color: #28a745 !important;
  color: #fff !important;
}

#message {
  margin-top: 1rem;
  text-align: center;
  font-weight: 300;
  color: #000;
}

/* Résumé commande */
.summary {
  flex: 1;
  max-width: 500px;
  background-color: #fff;
  padding: 2rem;
  border: 1px solid #000;
}

.summary h3 {
  font-weight: 400;
  margin-bottom: 2rem;
  text-align: center;
  letter-spacing: 0.2rem;
  text-transform: uppercase;
  font-size: 1.5rem;
  color: #000;
}

#commande-list {
  margin-bottom: 2rem;
}

.article-panier {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 0;
  border-bottom: 1px solid #000;
  position: relative;
}

.details-panier {
  display: flex;
  gap: 1rem;
}

.details-panier img {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border: 1px solid #000;
}

.details-panier h4 {
  font-weight: 500;
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.05rem;
  color: #000;
}

.details-panier p {
  font-weight: 300;
  font-size: 0.9rem;
  margin-bottom: 0.3rem;
  color: #000;
}

.prix-total {
  font-weight: 500;
  margin-top: 0.5rem;
  color: #000;
}

.supprimer {
  background: none;
  border: none;
  color: #000;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0 0.5rem;
}

.commande-total {
  text-align: right;
  font-size: 1.2rem;
  font-weight: 500;
  letter-spacing: 0.1rem;
  color: #000;
}

#payer-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.8rem 1.5rem;
  margin: 2rem;
  text-decoration: none;
  color: #000;
  border: 1.5px solid #000;
  background: transparent;
  font-size: 0.8rem;
  letter-spacing: 0.1rem;
  font-weight: 500;
  text-transform: uppercase;
  gap: 0.5rem;
  position: relative;
  overflow: hidden;
  transition: color 0.2s 0.2s;
}

#payer-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 0;
  height: 100%;
  background: #000;
  transition: width 0.3s ease-out;
  z-index: -1;
}

#payer-btn > * {
  position: relative;
  z-index: 1;
}

#payer-btn:hover {
  color: #fff !important;
  transition-delay: 0.1s;
}

#payer-btn:hover::before {
  width: 100%;
}

#payer-btn:hover #prix-stripe {
  color: #fff;
  transform: translateX(2px);
}

.btn-icon {
  transition: transform 0.2s ease;
}

#payer-btn:hover .btn-icon {
  transform: translateX(-3px);
}

#btn-retour {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.8rem 1.5rem;
  margin: 2rem;
  text-decoration: none;
  color: #000;
  border: 1.5px solid #000;
  background: transparent;
  font-size: 0.8rem;
  letter-spacing: 0.1rem;
  font-weight: 500;
  text-transform: uppercase;
  gap: 0.5rem;
  position: relative;
  overflow: hidden;
  transition: color 0.2s 0.2s;
}

#btn-retour::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 0;
  height: 100%;
  background: #000;
  transition: width 0.3s ease-out;
  z-index: -1;
}

#btn-retour > * {
  position: relative;
  z-index: 1;
}

#btn-retour:hover {
  color: #fff !important;
  transition-delay: 0.1s;
}

#btn-retour:hover::before {
  width: 100%;
}

#btn-retour:hover #prix-stripe {
  color: #fff;
  transform: translateX(2px);
}

#btn-retour:hover .btn-icon {
  transform: translateX(-3px);
}

#payer-btn.btn-disabled {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: auto;
}

@keyframes clignoter {
  0%, 100% { background-color: red; }
  50% { background-color: #ff4d4d; }
}

.btn-error {
  background-color: red !important;
  animation: clignoter 0.4s ease-in-out 3;
}

  
</style>


  



</head>
<body>


<header class="header">
  <h1>COMMANDE</h1>

 

</header>

<a href="Card.html" id="btn-retour" class="btn-disabled" aria-disabled="true">
   <span class="btn-icon">←</span> Retour
</a>




<div class="container">
  <form id="form">
    <h2>Inscription</h2>

    <label for="name">Prénom</label>
    <input type="text" id="name" name="name" required />

    <label for="email">Email</label>
    <input type="email" id="email" name="email" required />

    <button type="submit">Envoyer</button>

    <p id="message"></p>
  </form>

  <div class="summary">
    <h3>Résumé de votre commande</h3>
    <div id="commande-list">
      <div id="liste-pizzas-panier"></div>
      <div id="liste-panier"></div>
    </div>
    <div id="commande-total" class="commande-total"></div>
  </div>
</div>



  <script>



    document.addEventListener('DOMContentLoaded', () => {
    const listePanier = document.getElementById('liste-panier');
    const commandeTotal = document.getElementById('commande-total');
    const form = document.getElementById('form');
    const message = document.getElementById('message');
    const emailInput = document.getElementById('email');

    // Récupération du panier
    let panier = JSON.parse(localStorage.getItem('panier')) || [];

    // Normalisation des données
    panier = panier.map(item => ({
        ...item,
        quantite: item.quantite || 1,
        supplements: item.supplements || [],
        options: item.options || {}
    }));

    function afficherPanier() {
        listePanier.innerHTML = '';
        let total = 0;

        if (panier.length === 0) {
            listePanier.innerHTML = '<p>Votre panier est vide.</p>';
            commandeTotal.textContent = '0.00 €';
            return;
        }

        panier.forEach(item => {
            const div = document.createElement('div');
            div.classList.add('article-panier');

            // Affichage spécifique pour les menus
            let detailsMenu = '';
            if (item.type === 'menu') {
                detailsMenu = `
                    <div class="details-menu">
                        <p><strong>• Burger :</strong> ${item.options.burger || 'Non spécifié'}</p>
                        <p><strong>• Accompagnement :</strong> 
                            ${item.options.accompagnement === 'frites' 
                                ? 'Frites' 
                                : item.options.dessert ? 'Dessert (' + item.options.dessert + ')' : 'Non spécifié'}
                        </p>
                        <p><strong>• Boisson :</strong> ${item.options.boisson || 'Non spécifié'}</p>
                    </div>
                `;
            }

            // Affichage des suppléments si existants
            let supplementsHtml = '';
            if (item.supplements && item.supplements.length > 0) {
                supplementsHtml = `
                    <div class="supplements">
                        <p><strong>Suppléments :</strong></p>
                        <ul>
                            ${item.supplements.map(sup => `<li>${sup.nom} (+${sup.prix.toFixed(2)} €)</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            const prixTotal = item.prix * item.quantite;
            total += prixTotal;

            div.innerHTML = `
                <div class="details-panier">
                    <img src="${item.image || 'https://via.placeholder.com/100?text=Produit'}" alt="${item.nom}" />
                    <div class="infos">
                        <h4>${item.nom} × ${item.quantite}</h4>
                        ${item.description ? `<p class="description">${item.description}</p>` : ''}
                        <p class="type"><strong>Type :</strong> ${
                            item.type === 'pizza' ? 'Pizza' :
                            item.type === 'burger' ? 'Burger' :
                            item.type === 'bagel' ? 'Bagel' :
                            item.type === 'tacos' ? 'Tacos' :
                            item.type === 'pates' ? 'Pates' :
                            item.type === 'salades' ? 'Salade' : 
                            item.type === 'sandwitchs_froids' ? 'Sandwich Froid' :
                            item.type === 'menu' ? 'Menu' :
                            item.type === 'boisson' ? 'Boisson' :
                            item.type === 'dessert' ? 'Dessert' :
                            'Autre'
                        }</p>
                        ${detailsMenu}
                        ${supplementsHtml}
                        <p class="prix"><strong>Prix unitaire :</strong> ${item.prix.toFixed(2)} €</p>
                        <p class="total-item"><strong>Total :</strong> ${prixTotal.toFixed(2)} €</p>
                    </div>
                </div>
                <button class="supprimer" title="Supprimer cet article">×</button>
            `;

            div.querySelector('.supprimer').addEventListener('click', () => {
                panier = panier.filter(p => p.id !== item.id);
                localStorage.setItem('panier', JSON.stringify(panier));
                afficherPanier();
            });

            listePanier.appendChild(div);
        });

        commandeTotal.innerHTML = `<strong>Total de la commande :</strong> ${total.toFixed(2)} €`;
    }

    // Validation d'email améliorée
    function validateEmail(email) {
        return /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9-]+\.[a-zA-Z]{2,6}(\.[a-zA-Z]{2,3})?$/.test(email) && 
               !/\.(ez|c2|xyz|tk|gq)$/i.test(email);
    }

    // Gestion du formulaire
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = form.name.value.trim();
        const email = form.email.value.trim();

        // Validation améliorée
        if (!name) {
            message.textContent = 'Veuillez entrer votre prénom';
            message.style.color = 'red';
            return;
        }

        if (!email) {
            message.textContent = 'Veuillez entrer votre email';
            message.style.color = 'red';
            return;
        }

        if (!validateEmail(email)) {
            message.textContent = 'Veuillez entrer une adresse email valide (ex: exemple@domaine.com)';
            message.style.color = 'red';
            return;
        }

        if (panier.length === 0) {
            message.textContent = 'Votre panier est vide';
            message.style.color = 'red';
            return;
        }

        message.textContent = 'Traitement de votre commande...';
        message.style.color = 'green';

        try {
            // Génération du numéro de commande
            const now = new Date();
            const orderNum = `CMD-${String(now.getDate()).padStart(2,'0')}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;

            // Préparation des données par catégorie (incluant maintenant les pâtes)
const commandeData = {
    numero_cmd: orderNum,
    client: { name, email },
    pizzas: panier.filter(item => item.type === 'pizza'),
    burgers: panier.filter(item => item.type === 'burger'),
    bagels: panier.filter(item => item.type === 'bagel'),
    menus: panier.filter(item => item.type === 'menu'),
    boissons: panier.filter(item => item.type === 'boisson'),
    desserts: panier.filter(item => item.type === 'dessert'),
    tacos: panier.filter(item => item.type === 'tacos'),
    pates: panier.filter(item => item.type === 'pates'), // ← AJOUT ICI
    sandwitchs_froids: panier.filter(item => item.type === 'sandwitchs_froids'), // ←  ICI LES sandwitchs
    salades: panier.filter(item => item.type === 'salades'), // ← SALADES
    supplements: panier.flatMap(item => item.supplements || []),
    total: panier.reduce((sum, item) => sum + (item.prix * item.quantite), 0)
};


            const response = await fetch('/api/enregistrer-commande', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(commandeData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Erreur serveur');
            }

            const result = await response.json();

            if (result.paymentUrl) {
                window.location.href = result.paymentUrl;
            } else {
                message.textContent = 'Commande enregistrée avec succès!';
                localStorage.removeItem('panier');
                setTimeout(() => window.location.href = '/success.html', 2000);
            }
        } catch (error) {
            console.error('Erreur:', error);
            message.textContent = 'Erreur lors du traitement: ' + (error.message || 'Veuillez réessayer');
            message.style.color = 'red';
        }
    });

    // Initialisation
    afficherPanier();
});

    
  </script>
