<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Formulaire & Résumé commande</title>



<style>
  /* Base stylée */
  body {
    font-family: 'Montserrat', sans-serif;
    background-color: #ffffff;
    color: #000000;
    margin: 0;
    padding: 0;
    line-height: 1.6;
  }

  /* Header */
  .header {
    background-color: #000000;
    color: white;
    padding: 1.5rem 0;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
  }

  .header h1 {
    margin: 0;
    font-size: 1.8rem;
    letter-spacing: 1px;
    font-weight: 500;
  }

  /* Container principal */
  .container {
    display: flex;
    max-width: 1200px;
    margin: 0 auto 3rem;
    padding: 0 2rem;
    gap: 3rem;
  }

  /* Formulaire */
  #form {
    flex: 1;
    padding: 2rem;
    background: white;
    border-radius: 0;
    border: 1px solid #e0e0e0;
  }

  #form h2 {
    font-size: 1.8rem;
    margin-bottom: 2rem;
    font-weight: 400;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    letter-spacing: 0.5px;
  }

  input {
    width: 100%;
    padding: 12px 15px;
    margin-bottom: 1.5rem;
    border: 1px solid #e0e0e0;
    border-radius: 0;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
    background-color: white;
    transition: all 0.3s ease;
  }

  input:focus {
    outline: none;
    border-color: #000000;
  }

  button {
    width: 100%;
    padding: 14px;
    background-color: #000000;
    color: white;
    border: none;
    border-radius: 0;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9rem;
    font-weight: 500;
    letter-spacing: 1.5px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    margin-top: 1rem;
  }

  button:hover {
    background-color: #333333;
  }

  #message {
    margin-top: 1.5rem;
    padding: 0.8rem;
    text-align: center;
    font-size: 0.9rem;
  }

  /* Résumé commande */
  .summary {
    flex: 1;
    padding: 2rem;
    background: white;
    border: 1px solid #e0e0e0;
  }

  .summary h3 {
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    font-weight: 400;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  #commande-list {
    margin-bottom: 2rem;
  }

  #commande-list > div {
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e0e0e0;
  }

  #commande-list > div:last-child {
    border-bottom: none;
  }

  #commande-list div div {
    margin-bottom: 1rem;
    padding: 1rem;
    background: #f9f9f9;
  }

  .commande-total {
    font-size: 1.1rem;
    font-weight: 500;
    text-align: center;
    padding: 1rem;
    background: #f9f9f9;
    border: 1px solid #e0e0e0;
    margin-top: 1rem;
    letter-spacing: 1px;
  }

.error {
  border: 2px solid red !important;
}

.success {
  border: 2px solid green !important;
}




  /* Responsive */
  @media (max-width: 768px) {
    .container {
      flex-direction: column;
      padding: 0 1rem;
    }

    #form, .summary {
      padding: 1.5rem;
      border-left: none;
      border-right: none;
    }




  }


#payer-btn {
  background-color: white;
  color: #000000;
  border: 2px solid #000000;
  padding: 14px 28px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  letter-spacing: 0.5px;
  transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
  position: relative;
  overflow: hidden;
  z-index: 1;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  font-family: 'Montserrat', sans-serif;
  text-transform: uppercase;
  text-decoration: none;
  display: inline-block;
    right: -4%;    /* au lieu de -100%, pour ne pas coller au bord */
  
}

#payer-btn::before {
  content: '';
  position: absolute;
  top: 0;
  right: -100%;
  width: 100%;
  height: 100%;
  background: #000000;
  z-index: -1;
  transition: all 0.6s cubic-bezier(0.77, 0, 0.175, 1);
}

#payer-btn:hover {
  color: white;
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
}

#payer-btn:hover::before {
  right: 0;
}

#payer-btn span {
  position: relative;
  z-index: 2;
  text-decoration: none;
}






</style>



<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">


  <script src="https://js.stripe.com/v3/"></script>

</head>
<body>


<header class="header">
  <h1>COMMANDE</h1>

 

</header>

  <a href="boissons.html" id="payer-btn" class="btn-disabled" aria-disabled="true">
   < - Retour  <span id="prix-stripe"></span>
</a>

<br><br><br><br><br><br><br>

<div class="container">
  <form id="form">
    <h2>Inscription</h2>

    <label for="name">Prénom</label>
    <input type="text" id="name" name="name" required />

    <label for="email">Email</label>
    <input type="email" id="email" name="email" required />

    <button type="submit">Envoyer</button>

    <p id="message"></p>
  </form>

  <div class="summary">
    <h3>Résumé de votre commande</h3>
    <div id="commande-list">
      <div id="liste-pizzas-panier"></div>
      <div id="liste-panier"></div>
    </div>
    <div id="commande-total" class="commande-total"></div>
  </div>
</div>









<script>
  // Affiche les pizzas dans le panier et retourne le total pizzas
  function afficherPanierPizzas() {
    const listePizzasEl = document.getElementById('liste-pizzas-panier');
    const panierPizzas = JSON.parse(localStorage.getItem('panier')) || [];
    listePizzasEl.innerHTML = '';

    if (panierPizzas.length === 0) {
        listePizzasEl.textContent = "Votre panier pizzas est vide.";
        return 0;
    }

    let totalPizzas = 0;
    
    // Regrouper les éléments identiques
    const groupedItems = {};
    
    panierPizzas.forEach(p => {
        // Créer une clé unique pour chaque combinaison pizza + suppléments
        const suppKey = p.supplements && p.supplements.length > 0 && !(p.supplements.length === 1 && p.supplements[0].id === 'aucun')
            ? p.supplements.map(sup => sup.id).sort().join(',')
            : 'no_supp';
        
        const key = `${p.nom}_${p.taille || 'notaille'}_${suppKey}`;
        
        if (!groupedItems[key]) {
            groupedItems[key] = {
                ...p,
                quantity: 1,
                supplementsList: p.supplements || []
            };
        } else {
            groupedItems[key].quantity++;
        }
    });

    // Afficher les éléments groupés
    Object.values(groupedItems).forEach(item => {
        let prixPizza = item.prix || 0;
        let supplementsText = '';

        if (item.supplementsList && item.supplementsList.length > 0 && !(item.supplementsList.length === 1 && item.supplementsList[0].id === 'aucun')) {
            const prixSupp = item.supplementsList.reduce((acc, sup) => acc + (sup.prix || 0), 0);
            prixPizza += prixSupp;
            supplementsText = 'Suppléments : ' + item.supplementsList.map(sup => `${sup.nom} (${sup.prix.toFixed(2)} €)`).join(', ');
        }

        totalPizzas += prixPizza * item.quantity;

        // Affiche la taille uniquement si c'est une pizza
        let tailleTexte = '';
        if (item.nom.toLowerCase().includes('pizza')) {
            tailleTexte = item.taille ? ` (${item.taille})` : ' (taille inconnue)';
        }

        const div = document.createElement('div');
        div.innerHTML = `<strong>${item.quantity}x ${item.nom}</strong>${tailleTexte} - Prix total : ${(prixPizza * item.quantity).toFixed(2)} €<br>${supplementsText}`;
        listePizzasEl.appendChild(div);
    });

    return totalPizzas;
}

  // Affiche les boissons dans le panier et retourne le total boissons
function afficherPanierBoissons() {
  const listeBoissonsEl = document.getElementById('liste-panier');  // <-- ici
  const panierBoissons = JSON.parse(localStorage.getItem('boissons')) || [];
  listeBoissonsEl.innerHTML = '';

  if (panierBoissons.length === 0) {
    listeBoissonsEl.textContent = "Votre panier boissons est vide.";
    return 0;
  }

  let totalBoissons = 0;

  panierBoissons.forEach(b => {
    const prixBoisson = b.prix || 0;
    totalBoissons += prixBoisson;

    const div = document.createElement('div');
    div.innerHTML = `<strong>${b.nom}</strong> - Prix : ${prixBoisson.toFixed(2)} €`;
    listeBoissonsEl.appendChild(div);
  });

  return totalBoissons;
}


  // Affiche le montant total de la commande (pizzas + boissons)
  function afficherTotalGeneral() {
    const totalEl = document.getElementById('commande-total');
    const totalPizzas = afficherPanierPizzas();
    const totalBoissons = afficherPanierBoissons();
    const totalGeneral = totalPizzas + totalBoissons;
    totalEl.textContent = `Montant total de la commande : ${totalGeneral.toFixed(2)} €`;
  }

  // Nettoie les données des suppléments (pour éviter d’envoyer trop d’infos inutiles)
  function nettoyerSupplements(supplements) {
    if (!Array.isArray(supplements)) return [];
    return supplements.map(sup => ({
      id: sup.id,
      nom: sup.nom,
      prix: sup.prix
    }));
  }

  // Validation simple d'email avec regex
  function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }

  document.addEventListener('DOMContentLoaded', () => {
    afficherTotalGeneral();

    const form = document.getElementById('form');
    const nameInput = document.getElementById('name');
    const emailInput = document.getElementById('email');
    const messageEl = document.getElementById('message');
    const totalGlobal = afficherPanierPizzas() + afficherPanierBoissons();
     console.log("Total global de la commande :", totalGlobal.toFixed(2) + " €");


    // Gestion du style lors de la saisie du nom
    nameInput.addEventListener('input', () => {
      if (nameInput.value.trim() === '') {
        nameInput.classList.add('error');
        nameInput.classList.remove('success');
      } else {
        nameInput.classList.remove('error');
        nameInput.classList.add('success');
      }
    });

    // Gestion du style lors de la saisie de l'email
    emailInput.addEventListener('input', () => {
      const email = emailInput.value.trim();
      if (email === '' || !validateEmail(email)) {
        emailInput.classList.add('error');
        emailInput.classList.remove('success');
      } else {
        emailInput.classList.remove('error');
        emailInput.classList.add('success');
      }
    });

    // Soumission du formulaire
    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      const name = nameInput.value.trim();
      const email = emailInput.value.trim();

      nameInput.classList.remove('error', 'success');
      emailInput.classList.remove('error', 'success');
      messageEl.textContent = '';

      let hasError = false;

      if (name === '') {
        nameInput.classList.add('error');
        hasError = true;
      } else {
        nameInput.classList.add('success');
      }

      if (email === '' || !validateEmail(email)) {
        emailInput.classList.add('error');
        hasError = true;
      } else {
        emailInput.classList.add('success');
      }

      if (hasError) {
        messageEl.textContent = "Veuillez corriger les erreurs avant de soumettre.";
        messageEl.style.color = 'red';
        return;
      }

      // Préparer les données du panier avec les suppléments nettoyés
      let panierPizzas = JSON.parse(localStorage.getItem('panier')) || [];
      const panierBoissons = JSON.parse(localStorage.getItem('boissons')) || [];

      panierPizzas = panierPizzas.map(pizza => ({
        ...pizza,
        supplements: nettoyerSupplements(pizza.supplements)
      }));

      messageEl.textContent = "Création de la session de paiement...";
      messageEl.style.color = 'inherit';

      try {
        // Enregistrer la commande dans la base (API backend)
        const supabaseResponse = await fetch('/api/enregistrer-commande', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, panierPizzas, panierBoissons }),
        });

        if (!supabaseResponse.ok) {
          throw new Error('Échec de l\'enregistrement de la commande');
        }

        // Créer la session de paiement Stripe
        const response = await fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, panierPizzas, panierBoissons }),
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la création du paiement');
        }

        const data = await response.json();

        const stripe = Stripe('pk_test_51RTMhuLFHVbWJugP4qxMRQfifObErZnVAbMeDFwFTGcneOkBYomW3KFhvPHudKzoIn1IvdA6CAbOlL0lbAiNLrX300TLI92CDE');
        const { error } = await stripe.redirectToCheckout({ sessionId: data.sessionId });

        if (error) {
          throw error;
        }
      } catch (error) {
        console.error('Erreur:', error);
        messageEl.textContent = "Erreur : " + error.message;
        messageEl.style.color = 'red';
      }
    });
  });
</script>

  </body>
</html>
