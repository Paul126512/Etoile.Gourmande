<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Formulaire & R√©sum√© commande</title>


<style>
  /* Style g√©n√©ral noir et blanc */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Montserrat', sans-serif;
  }

  body {
    background-color: #000;
    color: #fff;
    line-height: 1.6;
    padding: 0;
    margin: 0;
  }

  .header {
    background-color: #000;
    color: #fff;
    padding: 2rem;
    text-align: center;
    border-bottom: 1px solid #fff;
  }

  .header h1 {
    font-weight: 400;
    letter-spacing: 0.5rem;
    text-transform: uppercase;
    font-size: 1.8rem;
  }

  .container {
    display: flex;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    gap: 3rem;
  }

  /* Formulaire */
  #form {
    flex: 1;
    max-width: 500px;
    background-color: #000;
    padding: 2rem;
    border: 1px solid #fff;
  }

  #form h2 {
    font-weight: 400;
    margin-bottom: 2rem;
    text-align: center;
    letter-spacing: 0.2rem;
    text-transform: uppercase;
    font-size: 1.5rem;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 300;
    letter-spacing: 0.1rem;
  }

  input {
    width: 100%;
    padding: 1rem;
    margin-bottom: 1.5rem;
    background-color: transparent;
    border: 1px solid #fff;
    color: #fff;
    font-size: 1rem;
  }

  input:focus {
    outline: none;
    border-color: #fff;
  }

button[type="submit"] {
  padding: 0.8rem 1.5rem;
  font-size: 1rem;
  border: 2px solid #ccc;
  background-color: #f5f5f5;
  color: #333;
  cursor: pointer;
  transition: all 0.3s ease;
}

/* üíö Style compl√®tement vert si valide */
button[type="submit"].valid {
  background-color: #28a745 !important; /* vert */
  border-color: #28a745 !important;
  color: #fff !important;
}


  #message {
    margin-top: 1rem;
    text-align: center;
    font-weight: 300;
  }

  /* R√©sum√© commande */
  .summary {
    flex: 1;
    max-width: 500px;
    background-color: #000;
    padding: 2rem;
    border: 1px solid #fff;
  }

  .summary h3 {
    font-weight: 400;
    margin-bottom: 2rem;
    text-align: center;
    letter-spacing: 0.2rem;
    text-transform: uppercase;
    font-size: 1.5rem;
  }

  #commande-list {
    margin-bottom: 2rem;
  }

  .article-panier {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid #fff;
    position: relative;
  }

  .details-panier {
    display: flex;
    gap: 1rem;
  }

  .details-panier img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border: 1px solid #fff;
  }

  .details-panier h4 {
    font-weight: 500;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05rem;
  }

  .details-panier p {
    font-weight: 300;
    font-size: 0.9rem;
    margin-bottom: 0.3rem;
  }

  .prix-total {
    font-weight: 500;
    margin-top: 0.5rem;
  }

  .supprimer {
    background: none;
    border: none;
    color: #fff;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0 0.5rem;
  }

  .commande-total {
    text-align: right;
    font-size: 1.2rem;
    font-weight: 500;
    letter-spacing: 0.1rem;
  }

 
#payer-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.8rem 1.5rem;
  margin: 2rem;
  text-decoration: none;
  color: #fff;
  border: 1.5px solid #fff;
  background: transparent;
  font-size: 0.8rem;
  letter-spacing: 0.1rem;
  font-weight: 500;
  text-transform: uppercase;
  gap: 0.5rem;
  position: relative;
  overflow: hidden;
  transition: color 0.2s 0.2s;
}

#payer-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 0;
  height: 100%;
  background: #fff;
  transition: width 0.3s ease-out;
  z-index: -1;
}

/* √âl√©ments du bouton (texte et ic√¥ne) */
#payer-btn > * {
  position: relative;
  z-index: 1;
}

#payer-btn:hover {
   color: #000 !important;
  transition-delay: 0.1s;
}

#payer-btn:hover::before {
  width: 100%;
}

/* Animation sp√©cifique pour le prix */
#prix-stripe {
  transition: transform 0.2s ease, color 0.2s;
}

#payer-btn:hover #prix-stripe {
  color: #000;
  transform: translateX(2px);
}

/* Style de l'ic√¥ne */
.btn-icon {
  transition: transform 0.2s ease;
}

#payer-btn:hover .btn-icon {
  transform: translateX(-3px);
}




#btn-retour {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.8rem 1.5rem;
  margin: 2rem;
  text-decoration: none;
  color: #fff;
  border: 1.5px solid #fff;
  background: transparent;
  font-size: 0.8rem;
  letter-spacing: 0.1rem;
  font-weight: 500;
  text-transform: uppercase;
  gap: 0.5rem;
  position: relative;
  overflow: hidden;
  transition: color 0.2s 0.2s;
}

#btn-retour::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 0;
  height: 100%;
  background: #fff;
  transition: width 0.3s ease-out;
  z-index: -1;
}


/* √âl√©ments du bouton (texte et ic√¥ne) */
#btn-retour > * {
  position: relative;
  z-index: 1;
}

#btn-retour:hover {
   color: #000 !important;
  transition-delay: 0.1s;
}

#btn-retour:hover::before {
  width: 100%;
}


#btn-retour:hover #prix-stripe {
  color: #000;
  transform: translateX(2px);
}

/* Style de l'ic√¥ne */
.btn-icon {
  transition: transform 0.2s ease;
}

#btn-retour:hover .btn-icon {
  transform: translateX(-3px);
}






/* √âtat d√©sactiv√© - √† garder en dernier pour priorit√© */
#payer-btn.btn-disabled {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: auto;
}

@keyframes clignoter {
  0%, 100% { background-color: red; }
  50% { background-color: #ff4d4d; }
}

.btn-error {
  background-color: red !important;
  animation: clignoter 0.4s ease-in-out 3;
}





</style>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">


  <script src="https://js.stripe.com/v3/"></script>

</head>
<body>


<header class="header">
  <h1>COMMANDE</h1>

 

</header>

<a href="Card.html" id="btn-retour" class="btn-disabled" aria-disabled="true">
   <span class="btn-icon">‚Üê</span> Retour
</a>




<div class="container">
  <form id="form">
    <h2>Inscription</h2>

    <label for="name">Pr√©nom</label>
    <input type="text" id="name" name="name" required />

    <label for="email">Email</label>
    <input type="email" id="email" name="email" required />

    <button type="submit">Envoyer</button>

    <p id="message"></p>
  </form>

  <div class="summary">
    <h3>R√©sum√© de votre commande</h3>
    <div id="commande-list">
      <div id="liste-pizzas-panier"></div>
      <div id="liste-panier"></div>
    </div>
    <div id="commande-total" class="commande-total"></div>
  </div>
</div>







<script src="https://js.stripe.com/v3/"></script>




<script>
const listePanier = document.getElementById('liste-panier');
const commandeTotal = document.getElementById('commande-total');
const payerBtn = document.getElementById('payer-btn');
const prixStripeSpan = document.getElementById('prix-stripe');

const supplementsDisponibles = [
  { id: 'sup1', nom: 'OLD SYSTEM  / DISABLE', prix: 1.50 },
  { id: 'sup2', nom: 'OLD SYSTEM  / DISABLE', prix: 2.00 },
  { id: 'sup3', nom: 'OLD SYSTEM  / DISABLE', prix: 1.00 },
  { id: 'sup4', nom: 'OLD SYSTEM  / DISABLE  ! ', prix: 1.20 },
];

// R√©cup√©rer panier depuis localStorage ou tableau vide
let panier = JSON.parse(localStorage.getItem('panier')) || [];

// Ajouter valeurs par d√©faut
panier = panier.map(item => ({
  ...item,
  quantite: item.quantite || 1,
  supplements: item.supplements || []
}));

// Fonction pour calculer le prix total d‚Äôun article (avec suppl√©ments)
function calculerPrixTotalItem(item) {
  const prixBase = item.prix || 0;
  // On ne fait plus la somme des suppl√©ments, on suppose que c‚Äôest d√©j√† inclus dans item.prix
  return prixBase * (item.quantite || 1);
}

// Grouper les articles identiques (par id et suppl√©ments)
function groupItems(items) {
  const groups = [];
  items.forEach(item => {
    // On cr√©e un tableau tri√© des ids de suppl√©ments pour la comparaison
    const supplementsIdsSorted = item.supplements.map(s => s.id).sort();

    // Chercher un groupe existant avec m√™me id, m√™me taille et m√™mes suppl√©ments
    const found = groups.find(g => {
      const gSupplementsIdsSorted = g.supplements.map(s => s.id).sort();
      return (
        g.id === item.id &&
        g.taille === item.taille &&  // Ajout de la condition taille
        JSON.stringify(gSupplementsIdsSorted) === JSON.stringify(supplementsIdsSorted)
      );
    });

    if (found) {
      found.items.push(item);
    } else {
      groups.push({ 
        id: item.id, 
        taille: item.taille,     // On stocke aussi la taille dans le groupe
        supplements: item.supplements, 
        items: [item] 
      });
    }
  });
  return groups;
}

// Affiche le panier dans le DOM
function afficherPanier() {
  listePanier.innerHTML = '';
  if (panier.length === 0) {
    listePanier.innerHTML = '<p>Votre panier est vide.</p>';
    commandeTotal.textContent = '0.00 ‚Ç¨';
    payerBtn.classList.add('btn-disabled');
    payerBtn.setAttribute('aria-disabled', 'true');
    prixStripeSpan.textContent = '';
    return;
  }

  // Regroupe les articles
  const groupedItems = groupItems(panier);

  let total = 0;

  groupedItems.forEach(group => {
    const item = group.items[0];
    const quantiteTotale = group.items.reduce((acc, it) => acc + (it.quantite || 1), 0);
    const prixTotalGroup = group.items.reduce((sum, it) => sum + calculerPrixTotalItem(it), 0);
    total += prixTotalGroup;

    const li = document.createElement('div');
    li.classList.add('article-panier');
    li.innerHTML = `
      <div class="details-panier">
        <img src="${item.image || 'https://via.placeholder.com/100?text=Produit'}" alt="${item.nom}" />
        <div>
          <h4>${item.nom} ${quantiteTotale > 1 ? `x${quantiteTotale}` : ''}</h4>
          <p><strong>Taille :</strong> ${item.taille || 'Standard'}</p>
          <p>${item.description || ''}</p>
          ${item.supplements.length > 0 ? `<p>Suppl√©ments : ${item.supplements.map(s => s.nom).join(', ')}</p>` : ''}
          <p class="prix-total">${prixTotalGroup.toFixed(2)} ‚Ç¨</p>
        </div>
      </div>
      <button class="supprimer" title="Supprimer cet article">√ó</button>
    `;

    // Supprimer cet article du panier
    li.querySelector('.supprimer').addEventListener('click', () => {
      // Supprimer toutes les occurrences correspondantes dans le panier
      panier = panier.filter(pItem => 
        !(pItem.id === item.id && 
          pItem.taille === item.taille &&
          JSON.stringify(pItem.supplements.map(s => s.id).sort()) === JSON.stringify(item.supplements.map(s => s.id).sort()))
      );
      sauvegarderPanier();
      afficherPanier();
    });

    listePanier.appendChild(li);
  });

  commandeTotal.textContent = total.toFixed(2) + ' ‚Ç¨';

  // Met √† jour le bouton "payer" avec le prix total
  if (total > 0) {
    payerBtn.classList.remove('btn-disabled');
    payerBtn.removeAttribute('aria-disabled');
    prixStripeSpan.textContent = ` - ${total.toFixed(2)} ‚Ç¨`;
  } else {
    payerBtn.classList.add('btn-disabled');
    payerBtn.setAttribute('aria-disabled', 'true');
    prixStripeSpan.textContent = '';
  }
}

// Sauvegarde panier dans localStorage
function sauvegarderPanier() {
  localStorage.setItem('panier', JSON.stringify(panier));
}

// Gestion du formulaire
const form = document.getElementById('form');
const message = document.getElementById('message');

function lancerAnimationErreur() {
  payerBtn.classList.remove('btn-error');  // reset animation
  void payerBtn.offsetWidth;                // trigger reflow
  payerBtn.classList.add('btn-error');     // lance l'animation
}

form.addEventListener('submit', async e => {
  e.preventDefault();

  const name = form.name.value.trim();
  const email = form.email.value.trim();

  // Simple validation
  if (name === '' || email === '') {
    message.textContent = 'Veuillez remplir tous les champs.';
    message.style.color = 'red';
    lancerAnimationErreur();
    return;
  }

  if (panier.length === 0) {
    message.textContent = 'Votre panier est vide.';
    message.style.color = 'red';
    lancerAnimationErreur();
    return;
  }

  // Message succ√®s / infos ok
  message.textContent = 'Informations re√ßues, pr√©paration du paiement...';
  message.style.color = 'green';

  // Pr√©parer les pizzas et boissons s√©par√©ment
  const panierPizzas = panier.filter(item => item.type === 'pizza');
  const panierBoissons = panier.filter(item => item.type === 'boisson');

  try {
    const response = await fetch('/api/enregistrer-commande', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name,
        email,
        panierPizzas,
        panierBoissons
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error || 'Erreur inconnue');
    }

    const data = await response.json();

    if (!window.Stripe) {
      message.textContent = 'Erreur Stripe non charg√©e.';
      message.style.color = 'red';
      lancerAnimationErreur();
      return;
    }

    const stripe = Stripe('pk_test_51RTMhuLFHVbWJugP4qxMRQfifObErZnVAbMeDFwFTGcneOkBYomW3KFhvPHudKzoIn1IvdA6CAbOlL0lbAiNLrX300TLI92CDE');

    // Redirection vers Stripe checkout
    const result = await stripe.redirectToCheckout({ sessionId: data.sessionId });

    if (result.error) {
      message.textContent = result.error.message;
      message.style.color = 'red';
      lancerAnimationErreur();
    }
  } catch (error) {
    message.textContent = `Erreur : ${error.message}`;
    message.style.color = 'red';
    lancerAnimationErreur();
  }
});



// Initialisation
afficherPanier();
</script>
